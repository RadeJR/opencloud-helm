{{/*
Expand the name of the chart.
*/}}
{{- define "opencloud.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a default fully qualified app name.
We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).
If release name contains chart name it will be used as a full name.
*/}}
{{- define "opencloud.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Create chart name and version as used by the chart label.
*/}}
{{- define "opencloud.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Common labels
*/}}
{{- define "opencloud.labels" -}}
helm.sh/chart: {{ include "opencloud.chart" . }}
{{ include "opencloud.selectorLabels" . }}
{{- if .Chart.AppVersion }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
{{- end }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels
*/}}
{{- define "opencloud.selectorLabels" -}}
app.kubernetes.io/name: {{ include "opencloud.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{/*
Create the name of the service account to use
*/}}
{{- define "opencloud.serviceAccountName" -}}
{{- if .Values.opencloud.serviceAccount.create }}
{{- default (include "opencloud.fullname" .) .Values.opencloud.serviceAccount.name }}
{{- else }}
{{- default "default" .Values.opencloud.serviceAccount.name }}
{{- end }}
{{- end }}

{{/*
Create a fully qualified OpenCloud name.
*/}}
{{- define "opencloud.opencloud.fullname" -}}
{{- printf "%s-opencloud" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a fully qualified Keycloak name.
*/}}
{{- define "opencloud.keycloak.fullname" -}}
{{- printf "%s-keycloak" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a fully qualified PostgreSQL name.
*/}}
{{- define "opencloud.postgres.fullname" -}}
{{- printf "%s-postgres" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a fully qualified MinIO name.
*/}}
{{- define "opencloud.minio.fullname" -}}
{{- printf "%s-minio" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Return the OpenCloud domain
*/}}
{{- define "opencloud.domain" -}}
{{- .Values.global.domain.opencloud }}
{{- end }}

{{/*
Return the Keycloak domain
*/}}
{{- define "opencloud.keycloak.domain" -}}
{{- .Values.global.domain.keycloak }}
{{- end }}

{{/*
Return the MinIO domain
*/}}
{{- define "opencloud.minio.domain" -}}
{{- .Values.global.domain.minio }}
{{- end }}


{{/*
Return the Collabora domain
*/}}
{{- define "opencloud.collabora.domain" -}}
{{- .Values.global.domain.collabora }}
{{- end -}}



{{/*
Create a fully qualified Tika name.
*/}}
{{- define "opencloud.tika.fullname" -}}
{{- printf "%s-tika" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/* namespace helper removed - use .Release.Namespace directly */}}

{{/*
Return the image registry, using global override if set
*/}}
{{- define "opencloud.image.registry" -}}
{{- coalesce .global.image.registry .registry -}}
{{- end -}}

{{/*
Return the image pull policy, using global override if set
*/}}
{{- define "opencloud.image.pullPolicy" -}}
{{- coalesce .global.image.pullPolicy .pullPolicy -}}
{{- end -}}

{{/*
Return the full image name with registry
*/}}
{{- define "opencloud.image" -}}
{{- $registry := include "opencloud.image.registry" (dict "registry" .imageValues.registry "global" .global) -}}
{{- $tag := .imageValues.tag | default .Chart.AppVersion -}}
{{- if $registry -}}
{{- printf "%s/%s:%s" $registry .imageValues.repository $tag -}}
{{- else -}}
{{- printf "%s:%s" .imageValues.repository $tag -}}
{{- end -}}
{{- end -}}

{{/*
Return the appropriate apiVersion for ingress
*/}}
{{- define "opencloud.ingress.apiVersion" -}}
{{- if .Capabilities.APIVersions.Has "networking.k8s.io/v1/Ingress" -}}
{{- print "networking.k8s.io/v1" -}}
{{- else -}}
{{- print "networking.k8s.io/v1beta1" -}}
{{- end -}}
{{- end -}}

{{/*
Return the storage class name, using global override if local is not set
*/}}
{{- define "opencloud.storageClass" -}}
{{- if .local -}}
{{- if (eq "-" .local) -}}
{{- print "" -}}
{{- else -}}
{{- .local -}}
{{- end -}}
{{- else if .global -}}
{{- .global -}}
{{- end -}}
{{- end -}}

{{/*
Generate common environment variables for OpenCloud
*/}}
{{- define "opencloud.env.common" -}}
# OpenCloud URL
- name: OC_URL
  value: "https://{{ include "opencloud.domain" . }}"

# Available roles (only set if explicitly configured)
{{- with .Values.opencloud.config.graph.availableRoles }}
- name: GRAPH_AVAILABLE_ROLES
  value: {{ join "," . | quote }}
{{- end }}

# Log settings
- name: OC_LOG_LEVEL
  value: {{ .Values.opencloud.config.log.level | quote }}
- name: OC_LOG_COLOR
  value: {{ .Values.opencloud.config.log.color | quote }}
- name: OC_LOG_PRETTY
  value: {{ .Values.opencloud.config.log.pretty | quote }}

# Enable services that are not started automatically
{{- $addServices := .Values.opencloud.additionalServices | default (list) }}
{{- $collaboraEnabled := .Values.collaboration.collabora.enabled }}
{{- if $collaboraEnabled }}
  {{- $addServices = append $addServices "collaboration" }}
{{- end }}
{{- if gt (len $addServices) 0 }}
- name: OC_ADD_RUN_SERVICES
  value: {{ join "," $addServices | quote }}
{{- end }}

{{- $exclude := .Values.opencloud.excludeServices | default (list) }}
{{- if .Values.opencloud.nats.external.enabled }}
  {{- $exclude = append $exclude "nats" }}
{{- end }}
{{- $useExternalAuth := or .Values.identityProvider.external.enabled .Values.identityProvider.keycloak.enabled }}
{{- if $useExternalAuth }}
  {{- $exclude = append $exclude "idp" }}
{{- end }}
{{- if gt (len $exclude) 0 }}
- name: OC_EXCLUDE_RUN_SERVICES
  value: {{ join "," $exclude | quote }}
{{- end }}

# Proxy settings
- name: PROXY_TLS
  value: {{ .Values.opencloud.config.proxy.tls | quote }}
- name: PROXY_ENABLE_BASIC_AUTH
  {{- $oidcEnabled := or .Values.identityProvider.external.enabled .Values.identityProvider.keycloak.enabled }}
  {{- if $oidcEnabled }}
  value: "false"
  {{- else }}
  value: {{ .Values.opencloud.config.proxy.enableBasicAuth | quote }}
  {{- end }}

# INSECURE: needed if OpenCloud is using self generated certificates
- name: OC_INSECURE
  value: {{ tpl (toString .Values.opencloud.config.insecure) . | quote }}

# Sharing settings
- name: OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD
  value: {{ .Values.opencloud.config.sharing.publicShareMustHavePassword | quote }}

# Password policy
- name: OC_PASSWORD_POLICY_BANNED_PASSWORDS_LIST
  value: {{ .Values.opencloud.config.passwordPolicy.bannedPasswordsFile | quote }}

# Search settings
- name: SEARCH_EXTRACTOR_TYPE
{{- if and (eq .Values.opencloud.config.search.extractorType "tika") (not .Values.tika.enabled) }}
  value: "basic"
{{- else }}
  value: {{ .Values.opencloud.config.search.extractorType | quote }}
{{- end }}
{{- if .Values.tika.enabled }}
- name: SEARCH_EXTRACTOR_TIKA_TIKA_URL
  value: "http://{{ include "opencloud.tika.fullname" . }}:9998"
{{- end }}

# Performance settings
- name: OC_GRPC_MAX_RECEIVED_MESSAGE_SIZE
  value: {{ .Values.opencloud.config.grpc.maxReceivedMessageSize | quote }}

# CSP configuration
- name: PROXY_CSP_CONFIG_FILE_LOCATION
  value: "/etc/opencloud/csp.yaml"

# JWT Secret
- name: OC_JWT_SECRET
  valueFrom:
    secretKeyRef:
      name: {{- if .Values.opencloud.config.jwtSecret.existingSecret }}
              {{ .Values.opencloud.config.jwtSecret.existingSecret }}
            {{- else }}
              {{ include "opencloud.opencloud.fullname" . }}-jwt
            {{- end }}
      key: jwtSecret
{{- end -}}

{{/*
Generate SMTP environment variables for OpenCloud
*/}}
{{- define "opencloud.env.smtp" -}}
{{- if .Values.opencloud.smtp.enabled }}
- name: NOTIFICATIONS_SMTP_HOST
  value: "{{ .Values.opencloud.smtp.host }}"
- name: NOTIFICATIONS_SMTP_PORT
  value: "{{ .Values.opencloud.smtp.port }}"
- name: NOTIFICATIONS_SMTP_SENDER
  value: "{{ .Values.opencloud.smtp.sender | default (printf "OpenCloud notifications <notifications@%s>" (include "opencloud.domain" .)) }}"
- name: NOTIFICATIONS_SMTP_USERNAME
  valueFrom:
    secretKeyRef:
      name: {{- if .Values.opencloud.smtp.existingSecret }}
              {{ .Values.opencloud.smtp.existingSecret }}
            {{- else }}
              {{ include "opencloud.opencloud.fullname" . }}-smtp
            {{- end }}
      key: smtpUser
- name: NOTIFICATIONS_SMTP_PASSWORD
  valueFrom:
    secretKeyRef:
      name: {{- if .Values.opencloud.smtp.existingSecret }}
              {{ .Values.opencloud.smtp.existingSecret }}
            {{- else }}
              {{ include "opencloud.opencloud.fullname" . }}-smtp
            {{- end }}
      key: smtpPassword
- name: NOTIFICATIONS_SMTP_INSECURE
  value: {{ tpl (toString .Values.opencloud.smtp.insecure) . | quote }}
- name: NOTIFICATIONS_SMTP_AUTHENTICATION
  value: "{{ .Values.opencloud.smtp.authentication }}"
- name: NOTIFICATIONS_SMTP_ENCRYPTION
  value: "{{ .Values.opencloud.smtp.encryption }}"
{{- end }}
{{- end -}}

{{/*
Generate OIDC environment variables for OpenCloud
Supports both external OIDC providers and internal Keycloak deployment
External OIDC takes precedence over internal Keycloak
*/}}
{{- define "opencloud.env.oidc" -}}
{{- $oidcEnabled := or .Values.identityProvider.external.enabled .Values.identityProvider.keycloak.enabled }}
{{- if $oidcEnabled }}
{{- $useExternalOidc := .Values.identityProvider.external.enabled }}

# IDP specific configuration
- name: PROXY_AUTOPROVISION_ACCOUNTS
  value: {{ .Values.opencloud.config.proxy.autoprovisionAccounts | quote }}

# User properties are edited in the IDP, so we have to make them readonly
- name: FRONTEND_READONLY_USER_ATTRIBUTES
  value: {{ .Values.opencloud.config.frontend.readonlyUserAttributes | quote }}

- name: PROXY_ROLE_ASSIGNMENT_DRIVER
  value: {{ .Values.opencloud.config.proxy.roleAssignmentDriver | quote }}

# OIDC Issuer URL
- name: OC_OIDC_ISSUER
  {{- if $useExternalOidc }}
  value: {{ required "identityProvider.external.issuer is required when identityProvider.external.enabled is true" .Values.identityProvider.external.issuer | quote }}
  {{- else }}
  value: {{ printf "https://%s/realms/%s" (include "opencloud.keycloak.domain" .) .Values.identityProvider.keycloak.realm | quote }}
  {{- end }}

# Account management URL
- name: WEB_OPTION_ACCOUNT_EDIT_LINK_HREF
  {{- if $useExternalOidc }}
  value: {{ .Values.identityProvider.external.accountUrl | default "" | quote }}
  {{- else }}
  value: {{ printf "https://%s/realms/%s/account" (include "opencloud.keycloak.domain" .) .Values.identityProvider.keycloak.realm | quote }}
  {{- end }}

- name: PROXY_OIDC_REWRITE_WELLKNOWN
  value: {{ .Values.opencloud.config.proxy.oidc.rewriteWellknown | quote }}

# OIDC Client ID
- name: WEB_OIDC_CLIENT_ID
  {{- if $useExternalOidc }}
  value: {{ required "identityProvider.external.clientId is required when identityProvider.external.enabled is true" .Values.identityProvider.external.clientId | quote }}
  {{- else }}
  value: "web"
  {{- end }}

# User identification claims
- name: PROXY_USER_OIDC_CLAIM
  value: {{ .Values.opencloud.config.proxy.oidc.userOidcClaim | quote }}

- name: PROXY_USER_CS3_CLAIM
  value: {{ .Values.opencloud.config.proxy.oidc.userCs3Claim | quote }}

- name: OC_ADMIN_USER_ID
  value: {{ .Values.opencloud.config.admin.userId | quote }}

- name: GRAPH_ASSIGN_DEFAULT_USER_ROLE
  value: {{ .Values.opencloud.config.graph.assignDefaultUserRole | quote }}

- name: GRAPH_USERNAME_MATCH
  value: {{ .Values.opencloud.config.graph.usernameMatch | quote }}

# Role assignment claim
- name: PROXY_ROLE_ASSIGNMENT_OIDC_CLAIM
  value: {{ .Values.opencloud.config.proxy.oidc.roleAssignmentClaim | quote }}

- name: PROXY_OIDC_ACCESS_TOKEN_VERIFY_METHOD
  value: {{ .Values.opencloud.config.proxy.oidc.accessTokenVerifyMethod | quote }}

# OIDC metadata/discovery URL
- name: WEB_OIDC_METADATA_URL
  {{- if $useExternalOidc }}
  value: {{ printf "%s/.well-known/openid-configuration" .Values.identityProvider.external.issuer | quote }}
  {{- else }}
  value: {{ printf "https://%s/realms/%s/.well-known/openid-configuration" (include "opencloud.keycloak.domain" .) .Values.identityProvider.keycloak.realm | quote }}
  {{- end }}

# OIDC scopes
- name: WEB_OIDC_SCOPE
  value: {{ .Values.opencloud.config.web.oidcScope | quote }}
{{- end }}
{{- end -}}

{{/*
Generate admin and demo user environment variables
*/}}
{{- define "opencloud.env.admin" -}}
{{- if not (or .Values.identityProvider.keycloak.enabled .Values.identityProvider.external.enabled) }}
# Admin user password (only used when no identity provider is configured)
- name: IDM_ADMIN_PASSWORD
  valueFrom:
    secretKeyRef:
      name: {{- if .Values.identityProvider.internal.existingSecret }}
              {{ .Values.identityProvider.internal.existingSecret }}
            {{- else }}
              {{ include "opencloud.opencloud.fullname" . }}
            {{- end }}
      key: adminPassword
{{- end }}
# Demo users (only created when no identity provider is configured)
{{- if not (or .Values.identityProvider.keycloak.enabled .Values.identityProvider.external.enabled) }}
- name: IDM_CREATE_DEMO_USERS
  value: {{ .Values.identityProvider.internal.createDemoUsers | quote }}
{{- end }}
{{- end -}}

{{/*
Generate NATS environment variables
*/}}
{{- define "opencloud.env.nats" -}}
# Cache store type (always nats-js-kv for this chart)
- name: OC_CACHE_STORE
  value: "nats-js-kv"
{{- if .Values.opencloud.nats.external.enabled }}
# External NATS configuration
- name: OC_CACHE_STORE_NODES
  value: {{ .Values.opencloud.nats.external.endpoint | quote }}
- name: OC_PERSISTENT_STORE_NODES
  value: {{ .Values.opencloud.nats.external.endpoint | quote }}
- name: OC_EVENTS_ENDPOINT
  value: {{ .Values.opencloud.nats.external.endpoint | quote }}
- name: OC_EVENTS_CLUSTER
  value: {{ .Values.opencloud.nats.external.cluster | quote }}
- name: OC_EVENTS_ENABLE_TLS
  value: {{ .Values.opencloud.nats.external.tls.enabled | quote }}
{{- if not .Values.opencloud.nats.external.tls.certTrusted }}
- name: OC_EVENTS_TLS_ROOT_CA_CERTIFICATE
  value: /etc/opencloud/nats-ca/ca.crt
{{- end }}
{{- else }}
- name: NATS_NATS_HOST
  value: 0.0.0.0
{{- end }}
{{- end -}}

{{/*
Generate collaboration environment variables for built-in collaboration service
*/}}
{{- define "opencloud.env.collaboration" -}}
{{- $collaboraEnabled := .Values.collaboration.collabora.enabled }}
{{- $externalEnabled := .Values.collaboration.external.enabled }}

{{- $enabledCount := 0 }}
{{- if $collaboraEnabled }}{{- $enabledCount = add $enabledCount 1 }}{{- end }}
{{- if $externalEnabled }}{{- $enabledCount = add $enabledCount 1 }}{{- end }}

{{- if gt $enabledCount 1 }}
{{- fail "Only one collaboration provider can be enabled at the same time (collabora or external)!" }}
{{- end }}

{{- if $collaboraEnabled }}
# Collaboration service addresses (built-in service)
- name: COLLABORATION_GRPC_ADDR
  value: {{ .Values.collaboration.service.grpcAddr | quote }}
- name: COLLABORATION_HTTP_ADDR
  value: {{ .Values.collaboration.service.httpAddr | quote }}
- name: COLLABORATION_CS3API_DATAGATEWAY_INSECURE
  value: {{ .Values.opencloud.config.insecure | quote }}

# Collabora configuration
# Collabora configuration
- name: COLLABORATION_WOPI_SRC
  {{- if .Values.collaboration.collabora.wopiSrc }}
  value: {{ .Values.collaboration.collabora.wopiSrc | quote }}
  {{- else }}
  # Collabora can connect directly to the internal service
  value: "http://{{ include "opencloud.opencloud.fullname" . }}:9300"
  {{- end }}
- name: COLLABORATION_APP_NAME
  value: {{ .Values.collaboration.collabora.appName | quote }}
- name: COLLABORATION_APP_PRODUCT
  value: {{ .Values.collaboration.collabora.product | quote }}
- name: COLLABORATION_APP_ADDR
  {{- if .Values.collaboration.collabora.url }}
  value: {{ .Values.collaboration.collabora.url | quote }}
  {{- else }}
  value: "https://{{ include "opencloud.collabora.domain" . }}"
  {{- end }}
- name: COLLABORATION_APP_ICON
  {{- if .Values.collaboration.collabora.icon }}
  value: {{ .Values.collaboration.collabora.icon | quote }}
  {{- else }}
  value: "https://{{ include "opencloud.collabora.domain" . }}/favicon.ico"
  {{- end }}
{{- if .Values.collaboration.collabora.insecure }}
- name: COLLABORATION_APP_INSECURE
  value: "true"
{{- end }}
{{- end }}

{{- if $externalEnabled }}
# External collaboration provider configuration
- name: COLLABORATION_WOPI_SRC
  value: {{ required "collaboration.external.wopiSrc is required when using external collaboration provider" .Values.collaboration.external.wopiSrc | quote }}
- name: COLLABORATION_APP_NAME
  value: {{ required "collaboration.external.appName is required when using external collaboration provider" .Values.collaboration.external.appName | quote }}
- name: COLLABORATION_APP_PRODUCT
  value: {{ required "collaboration.external.product is required when using external collaboration provider" .Values.collaboration.external.product | quote }}
- name: COLLABORATION_APP_ADDR
  value: {{ required "collaboration.external.url is required when using external collaboration provider" .Values.collaboration.external.url | quote }}
{{- if .Values.collaboration.external.icon }}
- name: COLLABORATION_APP_ICON
  value: {{ .Values.collaboration.external.icon | quote }}
{{- end }}
{{- if .Values.collaboration.external.insecure }}
- name: COLLABORATION_APP_INSECURE
  value: "true"
{{- end }}
{{- end }}
{{- end -}}

{{/*
Generate storage environment variables
*/}}
{{- define "opencloud.env.storage" -}}
# Storage configuration
# Always use decomposeds3 for user storage and decomposed for system storage
- name: STORAGE_USERS_DRIVER
{{- if .Values.storage.posixfs.enabled }}
  value: "posix"
{{- else }}
  value: "decomposeds3"
{{- end }}
- name: STORAGE_SYSTEM_DRIVER
  value: "decomposed"

{{- if .Values.storage.posixfs.enabled }}
# POSIX filesystem storage
- name: STORAGE_USERS_POSIX_ROOT
  value: {{ .Values.storage.posixfs.rootPath | quote }}
- name: STORAGE_USERS_ID_CACHE_STORE
  value: {{ .Values.storage.posixfs.idCacheStore | quote }}
{{- else if .Values.storage.external.enabled }}
# External S3 storage
- name: STORAGE_USERS_DECOMPOSEDS3_ENDPOINT
  value: {{ .Values.storage.external.endpoint | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_REGION
  value: {{ .Values.storage.external.region | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_BUCKET
  value: {{ .Values.storage.external.bucket | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_CREATE_BUCKET
  value: {{ .Values.storage.external.createBucket | default true | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_ACCESS_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.storage.external.existingSecret | default (printf "%s-s3" (include "opencloud.opencloud.fullname" .)) }}
      key: accessKey
- name: STORAGE_USERS_DECOMPOSEDS3_SECRET_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.storage.external.existingSecret | default (printf "%s-s3" (include "opencloud.opencloud.fullname" .)) }}
      key: secretKey
{{- else }}
# Internal S3 (MinIO) storage
- name: STORAGE_USERS_DECOMPOSEDS3_ENDPOINT
  value: {{ printf "http://%s:9000" (include "opencloud.minio.fullname" .) | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_REGION
  value: {{ .Values.storage.internal.region | default "default" | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_BUCKET
  value: {{ .Values.storage.internal.bucketName | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_CREATE_BUCKET
  value: "true"
- name: STORAGE_USERS_DECOMPOSEDS3_ACCESS_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.storage.internal.existingSecret | default (include "opencloud.minio.fullname" .) }}
      key: rootUser
- name: STORAGE_USERS_DECOMPOSEDS3_SECRET_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.storage.internal.existingSecret | default (include "opencloud.minio.fullname" .) }}
      key: rootPassword
{{- end }}
{{- end -}}

{{/*
Ingress annotations presets for common ingress controllers
*/}}
{{- define "opencloud.ingress.annotations.nginx" -}}
nginx.ingress.kubernetes.io/configuration-snippet: |
  more_set_headers "X-Forwarded-Proto: https";
{{- end }}

{{- define "opencloud.ingress.annotations.nginx-no-snippets" -}}
nginx.ingress.kubernetes.io/proxy-set-headers: |
  X-Forwarded-Proto: https
{{- end }}

{{- define "opencloud.ingress.annotations.traefik" -}}
traefik.ingress.kubernetes.io/router.middlewares: {{ .Release.Namespace }}-add-x-forwarded-proto-https@kubernetescrd
{{- end }}

{{- define "opencloud.ingress.annotations.haproxy" -}}
haproxy.org/request-set-header: |
  X-Forwarded-Proto https
{{- end }}

{{- define "opencloud.ingress.annotations.contour" -}}
projectcontour.io/response-headers: |
  X-Forwarded-Proto: https
{{- end }}

{{- define "opencloud.ingress.annotations.istio" -}}
# Istio handles X-Forwarded-Proto automatically, no annotation needed
{{- end }}
