{{/*
Expand the name of the chart.
*/}}
{{- define "opencloud.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a default fully qualified app name.
We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).
If release name contains chart name it will be used as a full name.
*/}}
{{- define "opencloud.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Create chart name and version as used by the chart label.
*/}}
{{- define "opencloud.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Common labels
*/}}
{{- define "opencloud.labels" -}}
helm.sh/chart: {{ include "opencloud.chart" . }}
{{ include "opencloud.selectorLabels" . }}
{{- if .Chart.AppVersion }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
{{- end }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels
*/}}
{{- define "opencloud.selectorLabels" -}}
app.kubernetes.io/name: {{ include "opencloud.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{/*
Create the name of the service account to use
*/}}
{{- define "opencloud.serviceAccountName" -}}
{{- if .Values.serviceAccount.create }}
{{- default (include "opencloud.fullname" .) .Values.serviceAccount.name }}
{{- else }}
{{- default "default" .Values.serviceAccount.name }}
{{- end }}
{{- end }}

{{/*
Create a fully qualified OpenCloud name.
*/}}
{{- define "opencloud.opencloud.fullname" -}}
{{- printf "%s-opencloud" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a fully qualified Keycloak name.
*/}}
{{- define "opencloud.keycloak.fullname" -}}
{{- printf "%s-keycloak" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a fully qualified PostgreSQL name.
*/}}
{{- define "opencloud.postgres.fullname" -}}
{{- printf "%s-postgres" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a fully qualified MinIO name.
*/}}
{{- define "opencloud.minio.fullname" -}}
{{- printf "%s-minio" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Return the OpenCloud domain
*/}}
{{- define "opencloud.domain" -}}
{{- .Values.global.domain.opencloud }}
{{- end }}

{{/*
Return the Keycloak domain
*/}}
{{- define "opencloud.keycloak.domain" -}}
{{- .Values.global.domain.keycloak }}
{{- end }}

{{/*
Return the MinIO domain
*/}}
{{- define "opencloud.minio.domain" -}}
{{- .Values.global.domain.minio }}
{{- end }}


{{/*
Return the OnlyOffice domain
*/}}
{{- define "opencloud.onlyoffice.domain" -}}
{{- .Values.global.domain.onlyoffice }}
{{- end }}

{{/*
Return the Collabora domain
*/}}
{{- define "opencloud.collabora.domain" -}}
{{- .Values.global.domain.collabora }}
{{- end }}

{{/*
Return the Companion domain
*/}}
{{- define "opencloud.companion.domain" -}}
{{- .Values.global.domain.companion }}
{{- end }}

{{/*
Return the WOPI domain
*/}}
{{- define "opencloud.wopi.domain" -}}
{{- .Values.global.domain.wopi }}
{{- end }}

{{/*
Create a fully qualified Tika name.
*/}}
{{- define "opencloud.tika.fullname" -}}
{{- printf "%s-tika" (include "opencloud.fullname" .) | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/* namespace helper removed - use .Release.Namespace directly */}}

{{/*
Return the image registry, using global override if set
*/}}
{{- define "opencloud.image.registry" -}}
{{- coalesce .global.image.registry .registry -}}
{{- end -}}

{{/*
Return the image pull policy, using global override if set
*/}}
{{- define "opencloud.image.pullPolicy" -}}
{{- coalesce .global.image.pullPolicy .pullPolicy -}}
{{- end -}}

{{/*
Return the full image name with registry
*/}}
{{- define "opencloud.image" -}}
{{- $registry := include "opencloud.image.registry" (dict "registry" .imageValues.registry "global" .global) -}}
{{- if $registry -}}
{{- printf "%s/%s:%s" $registry .imageValues.repository .imageValues.tag -}}
{{- else -}}
{{- printf "%s:%s" .imageValues.repository .imageValues.tag -}}
{{- end -}}
{{- end -}}

{{/*
Return the appropriate apiVersion for ingress
*/}}
{{- define "opencloud.ingress.apiVersion" -}}
{{- if .Capabilities.APIVersions.Has "networking.k8s.io/v1/Ingress" -}}
{{- print "networking.k8s.io/v1" -}}
{{- else -}}
{{- print "networking.k8s.io/v1beta1" -}}
{{- end -}}
{{- end -}}

{{/*
Generate common environment variables for OpenCloud
*/}}
{{- define "opencloud.env.common" -}}
# OpenCloud URL
- name: OC_URL
  value: "https://{{ include "opencloud.domain" . }}"

# Available roles
- name: GRAPH_AVAILABLE_ROLES
  value: {{ join "," .Values.opencloud.config.env.graph.availableRoles | quote }}

# Log settings
- name: OC_LOG_LEVEL
  value: {{ .Values.opencloud.config.env.log.level | quote }}
- name: OC_LOG_COLOR
  value: {{ .Values.opencloud.config.env.log.color | quote }}
- name: OC_LOG_PRETTY
  value: {{ .Values.opencloud.config.env.log.pretty | quote }}

# Enable services that are not started automatically
{{- with .Values.opencloud.additionalServices }}
- name: OC_ADD_RUN_SERVICES
  value: {{ join "," . | quote }}
{{- end }}

{{- $exclude := .Values.opencloud.excludeServices | default (list) }}
{{- if .Values.opencloud.nats.external.enabled }}
  {{- $exclude = append $exclude "nats" }}
{{- end }}
{{- $useExternalAuth := or .Values.global.oidc.enabled .Values.keycloak.internal.enabled }}
{{- if $useExternalAuth }}
  {{- $exclude = append $exclude "idp" }}
{{- end }}
{{- if gt (len $exclude) 0 }}
- name: OC_EXCLUDE_RUN_SERVICES
  value: {{ join "," $exclude | quote }}
{{- end }}

# Proxy settings
- name: PROXY_TLS
  value: {{ .Values.opencloud.config.env.proxy.tls | quote }}
- name: PROXY_ENABLE_BASIC_AUTH
  value: {{ .Values.opencloud.config.env.proxy.enableBasicAuth | quote }}

# Gateway settings
- name: GATEWAY_GRPC_ADDR
  value: {{ .Values.opencloud.config.env.gateway.grpcAddr | quote }}

# INSECURE: needed if OpenCloud is using self generated certificates
- name: OC_INSECURE
  value: {{ tpl (toString .Values.opencloud.config.env.insecure) . | quote }}

# Domain configuration for web extensions
- name: ONLYOFFICE_DOMAIN
  value: "{{ .Values.global.domain.onlyoffice }}"
- name: COMPANION_DOMAIN
  value: "{{ .Values.global.domain.companion }}"

# Sharing settings
- name: OC_SHARING_PUBLIC_SHARE_MUST_HAVE_PASSWORD
  value: {{ .Values.opencloud.config.env.sharing.publicShareMustHavePassword | quote }}

# Password policy
- name: OC_PASSWORD_POLICY_BANNED_PASSWORDS_LIST
  value: {{ .Values.opencloud.config.env.passwordPolicy.bannedPasswordsFile | quote }}

# Search settings
- name: SEARCH_EXTRACTOR_TYPE
  value: {{ .Values.opencloud.config.env.search.extractorType | quote }}
- name: SEARCH_EXTRACTOR_TIKA_TIKA_URL
  value: "http://{{ include "opencloud.tika.fullname" . }}:9998"

# Performance settings
- name: OC_GRPC_MAX_RECEIVED_MESSAGE_SIZE
  value: {{ .Values.opencloud.config.env.grpc.maxReceivedMessageSize | quote }}

# CSP configuration
- name: PROXY_CSP_CONFIG_FILE_LOCATION
  value: "/etc/opencloud/csp.yaml"
{{- end -}}

{{/*
Generate SMTP environment variables for OpenCloud
*/}}
{{- define "opencloud.env.smtp" -}}
{{- if .Values.opencloud.smtp.enabled }}
- name: NOTIFICATIONS_SMTP_HOST
  value: "{{ .Values.opencloud.smtp.host }}"
- name: NOTIFICATIONS_SMTP_PORT
  value: "{{ .Values.opencloud.smtp.port }}"
- name: NOTIFICATIONS_SMTP_SENDER
  value: "{{ .Values.opencloud.smtp.sender | default (printf "OpenCloud notifications <notifications@%s>" (include "opencloud.domain" .)) }}"
- name: NOTIFICATIONS_SMTP_USERNAME
  valueFrom:
    secretKeyRef:
      name: {{- if .Values.opencloud.smtp.existingSecret }}
              {{ .Values.opencloud.smtp.existingSecret }}
            {{- else }}
              {{ include "opencloud.opencloud.fullname" . }}-smtp
            {{- end }}
      key: smtpUser
- name: NOTIFICATIONS_SMTP_PASSWORD
  valueFrom:
    secretKeyRef:
      name: {{- if .Values.opencloud.smtp.existingSecret }}
              {{ .Values.opencloud.smtp.existingSecret }}
            {{- else }}
              {{ include "opencloud.opencloud.fullname" . }}-smtp
            {{- end }}
      key: smtpPassword
- name: NOTIFICATIONS_SMTP_INSECURE
  value: {{ tpl (toString .Values.opencloud.smtp.insecure) . | quote }}
- name: NOTIFICATIONS_SMTP_AUTHENTICATION
  value: "{{ .Values.opencloud.smtp.authentication }}"
- name: NOTIFICATIONS_SMTP_ENCRYPTION
  value: "{{ .Values.opencloud.smtp.encryption }}"
{{- end }}
{{- end -}}

{{/*
Generate OIDC environment variables for OpenCloud
Supports both external OIDC providers and internal Keycloak deployment
External OIDC takes precedence over internal Keycloak
*/}}
{{- define "opencloud.env.oidc" -}}
{{- $oidcEnabled := or .Values.global.oidc.enabled .Values.keycloak.internal.enabled }}
{{- if $oidcEnabled }}
{{- $useExternalOidc := .Values.global.oidc.enabled }}

# IDP specific configuration
- name: PROXY_AUTOPROVISION_ACCOUNTS
  {{- if $useExternalOidc }}
  value: {{ default .Values.opencloud.config.env.proxy.autoprovisionAccounts .Values.global.oidc.autoProvision | quote }}
  {{- else }}
  value: {{ .Values.opencloud.config.env.proxy.autoprovisionAccounts | quote }}
  {{- end }}

# User properties are edited in the IDP, so we have to make them readonly
- name: FRONTEND_READONLY_USER_ATTRIBUTES
  value: {{ .Values.opencloud.config.env.frontend.readonlyUserAttributes | quote }}

- name: PROXY_ROLE_ASSIGNMENT_DRIVER
  {{- if $useExternalOidc }}
  value: {{ default .Values.opencloud.config.env.proxy.roleAssignmentDriver .Values.global.oidc.roleDriver | quote }}
  {{- else }}
  value: {{ .Values.opencloud.config.env.proxy.roleAssignmentDriver | quote }}
  {{- end }}

# OIDC Issuer URL
- name: OC_OIDC_ISSUER
  {{- if $useExternalOidc }}
  value: {{ required "global.oidc.issuer is required when global.oidc.enabled is true" .Values.global.oidc.issuer | quote }}
  {{- else }}
  value: {{ printf "https://%s/realms/%s" (include "opencloud.keycloak.domain" .) .Values.keycloak.internal.realm | quote }}
  {{- end }}

# Account management URL
- name: WEB_OPTION_ACCOUNT_EDIT_LINK_HREF
  {{- if $useExternalOidc }}
    {{- if .Values.global.oidc.accountUrl }}
  value: {{ .Values.global.oidc.accountUrl | quote }}
    {{- else }}
  value: ""
    {{- end }}
  {{- else }}
  value: {{ printf "https://%s/realms/%s/account" (include "opencloud.keycloak.domain" .) .Values.keycloak.internal.realm | quote }}
  {{- end }}

- name: PROXY_OIDC_REWRITE_WELLKNOWN
  value: {{ .Values.opencloud.config.env.proxy.oidc.rewriteWellknown | quote }}

# OIDC Client ID
- name: WEB_OIDC_CLIENT_ID
  value: {{ .Values.global.oidc.clientId | quote }}

# User identification claims
- name: PROXY_USER_OIDC_CLAIM
  {{- if $useExternalOidc }}
  value: {{ default .Values.opencloud.config.env.proxy.oidc.userOidcClaim .Values.global.oidc.userClaim | quote }}
  {{- else }}
  value: {{ .Values.opencloud.config.env.proxy.oidc.userOidcClaim | quote }}
  {{- end }}

- name: PROXY_USER_CS3_CLAIM
  value: {{ .Values.opencloud.config.env.proxy.oidc.userCs3Claim | quote }}

- name: OC_ADMIN_USER_ID
  value: {{ .Values.opencloud.config.env.admin.userId | quote }}

- name: GRAPH_ASSIGN_DEFAULT_USER_ROLE
  value: {{ .Values.opencloud.config.env.graph.assignDefaultUserRole | quote }}

- name: GRAPH_USERNAME_MATCH
  value: {{ .Values.opencloud.config.env.graph.usernameMatch | quote }}

# Role assignment claim
- name: PROXY_ROLE_ASSIGNMENT_OIDC_CLAIM
  {{- if $useExternalOidc }}
  value: {{ default .Values.opencloud.config.env.proxy.oidc.roleAssignmentClaim .Values.global.oidc.roleClaim | quote }}
  {{- else }}
  value: {{ .Values.opencloud.config.env.proxy.oidc.roleAssignmentClaim | quote }}
  {{- end }}

- name: PROXY_OIDC_ACCESS_TOKEN_VERIFY_METHOD
  value: {{ .Values.opencloud.config.env.proxy.oidc.accessTokenVerifyMethod | quote }}

# OIDC metadata/discovery URL
- name: WEB_OIDC_METADATA_URL
  {{- if $useExternalOidc }}
  value: {{ printf "%s/.well-known/openid-configuration" .Values.global.oidc.issuer | quote }}
  {{- else }}
  value: {{ printf "https://%s/realms/%s/.well-known/openid-configuration" (include "opencloud.keycloak.domain" .) .Values.keycloak.internal.realm | quote }}
  {{- end }}

# OIDC scopes
- name: WEB_OIDC_SCOPE
  {{- if $useExternalOidc }}
  value: {{ default .Values.opencloud.config.env.web.oidcScope .Values.global.oidc.scopes | quote }}
  {{- else }}
  value: {{ .Values.opencloud.config.env.web.oidcScope | quote }}
  {{- end }}
{{- end }}
{{- end -}}

{{/*
Generate admin and demo user environment variables
*/}}
{{- define "opencloud.env.admin" -}}
# Admin user password
- name: IDM_ADMIN_PASSWORD
  valueFrom:
    secretKeyRef:
      name: {{- if .Values.opencloud.existingSecret }}
              {{ .Values.opencloud.existingSecret }}
            {{- else }}
              {{ include "opencloud.opencloud.fullname" . }}
            {{- end }}
      key: adminPassword
# Demo users
- name: IDM_CREATE_DEMO_USERS
  value: {{ .Values.opencloud.createDemoUsers | quote }}
{{- end -}}

{{/*
Generate NATS environment variables
*/}}
{{- define "opencloud.env.nats" -}}
{{- if .Values.opencloud.nats.external.enabled }}
# Use the external nats as the service registry
- name: MICRO_REGISTRY_ADDRESS
  value: {{ .Values.opencloud.nats.external.endpoint | quote }}
# Use the external nats as the cache and persistent store
- name: OC_CACHE_STORE_NODES
  value: {{ .Values.opencloud.nats.external.endpoint | quote }}
- name: OC_PERSISTENT_STORE_NODES
  value: {{ .Values.opencloud.nats.external.endpoint | quote }}
# Use the external nats as the messaging system
- name: OC_EVENTS_ENDPOINT
  value: {{ .Values.opencloud.nats.external.endpoint | quote }}
- name: OC_EVENTS_CLUSTER
  value: {{ .Values.opencloud.nats.external.cluster | quote }}
- name: OC_EVENTS_ENABLE_TLS
  value: {{ .Values.opencloud.nats.external.tls.enabled | quote }}
- name: OC_EVENTS_TLS_INSECURE
  value: {{ .Values.opencloud.nats.external.tls.insecure | quote }}
{{- if not .Values.opencloud.nats.external.tls.certTrusted }}
- name: OC_EVENTS_TLS_ROOT_CA_CERTIFICATE
  value: /etc/opencloud/nats-ca/ca.crt
{{- end }}
{{- else }}
- name: MICRO_REGISTRY_ADDRESS
  value: "127.0.0.1:9233"
# Make the registry available to the app provider containers
- name: NATS_NATS_HOST
  value: "0.0.0.0"
- name: NATS_NATS_PORT
  value: "9233"
{{- end }}
{{- end -}}

{{/*
Generate storage environment variables
*/}}
{{- define "opencloud.env.storage" -}}
# Storage configuration
# Always use decomposeds3 for user storage and decomposed for system storage
- name: STORAGE_USERS_DRIVER
{{- if eq .Values.opencloud.storage.mode "posixfs" }}
  value: "posix"
{{- else }}
  value: "decomposeds3"
{{- end }}
- name: STORAGE_SYSTEM_DRIVER
  value: "decomposed"

{{- if eq .Values.opencloud.storage.mode "posixfs" }}
- name: STORAGE_USERS_POSIX_ROOT
  value: {{ .Values.opencloud.storage.posixfs.rootPath | quote }}
- name: STORAGE_USERS_ID_CACHE_STORE
  value: {{ .Values.opencloud.storage.posixfs.idCacheStore | quote }}
# S3 storage configuration
{{- else if and (eq .Values.opencloud.storage.mode "s3") .Values.opencloud.storage.s3.external.enabled }}
# External S3 storage
- name: STORAGE_USERS_DECOMPOSEDS3_ENDPOINT
  value: {{ .Values.opencloud.storage.s3.external.endpoint | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_REGION
  value: {{ .Values.opencloud.storage.s3.external.region | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_BUCKET
  value: {{ .Values.opencloud.storage.s3.external.bucket | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_CREATE_BUCKET
  value: {{ .Values.opencloud.storage.s3.external.createBucket | default true | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_ACCESS_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.opencloud.storage.s3.external.existingSecret | default (printf "%s-s3" (include "opencloud.opencloud.fullname" .)) }}
      key: accessKey
- name: STORAGE_USERS_DECOMPOSEDS3_SECRET_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.opencloud.storage.s3.external.existingSecret | default (printf "%s-s3" (include "opencloud.opencloud.fullname" .)) }}
      key: secretKey
{{- else }}
# Internal S3 (MinIO) storage
- name: STORAGE_USERS_DECOMPOSEDS3_ENDPOINT
  value: {{ printf "http://%s:9000" (include "opencloud.minio.fullname" .) | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_REGION
  value: {{ .Values.opencloud.storage.s3.internal.region | default "default" | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_BUCKET
  value: {{ .Values.opencloud.storage.s3.internal.bucketName | quote }}
- name: STORAGE_USERS_DECOMPOSEDS3_CREATE_BUCKET
  value: "true"
- name: STORAGE_USERS_DECOMPOSEDS3_ACCESS_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.opencloud.storage.s3.internal.existingSecret | default (include "opencloud.minio.fullname" .) }}
      key: rootUser
- name: STORAGE_USERS_DECOMPOSEDS3_SECRET_KEY
  valueFrom:
    secretKeyRef:
      name: {{ .Values.opencloud.storage.s3.internal.existingSecret | default (include "opencloud.minio.fullname" .) }}
      key: rootPassword
{{- end }}
{{- end -}}
